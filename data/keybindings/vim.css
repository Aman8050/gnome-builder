/* vim.css
 *
 * Copyright (C) 2015 Christian Hergert <christian@hergert.me>
 *
 * This file is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This file is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

/*
 * Contributing:
 *
 * There are a lot of corner cases that vim handles. As you can see from the
 * text below, we do not handle all of them. If you would like to contribute
 * something that is missing, please do!
 *
 * In general, we use the selectors at the bottom to determine which binding
 * sets are active in a mode.
 *
 * "set-mode" is used to move our way through the state machine. Take a look
 * at the current uses to get an idea. "permanent" means that the mode will
 * stay active until it has been released (by Escape or something). transient
 * means that the the mode will disappear after a followup key press. However,
 * transient mode may simply trigger another transient mode. (cip would be
 * an example of this.
 *
 * If you need more advanced operations than you can perform, you might have
 * to dig into IdeSourceView to add a new GSignal (with G_SIGNAL_ACTION flag).
 * Any signal with G_SIGNAL_ACTION set in the following widget hierarchy
 * should be callable from these bindings.
 *
 *   - GtkWidget
 *     - GtkTextView
 *       - GtkSourceView
 *         - IdeSourceView
 *
 * For example, you could make the ficticious three-finger-salute keybinding
 * to delete the entire buffer like so:
 *
 *   bind "<ctrl><alt>delete" { "movement" (first-line, 0, 0, 0)
 *                              "movement" (last-line, 1, 0, 0)
 *                              "movement" (last-char, 1, 0, 0)
 *                              "copy-clipboard" ()
 *                              "delete-selection" () };
 *
 * The "movement" action takes three parameters.
 *
 *   1) If we want to extend the selection with the movement. Otherwise, it
 *      will be cleared.
 *   2) If the movement is exclusive. See :help exlusive in vim.
 *   3) If the current count (digit prefix) should be applied to the movement.
 *
 * The first line will move the cursor to line and column 0:0. The second
 * movement will extend the selection to the last line of the file (1
 * indicates TRUE to the second action parameter "extend_selection").
 * The third movement will move to the end of the current line (now the last
 * line due to second movement). We then copy to the clipboard just to be
 * nice, and then delete the whole thing from the buffer.
 *
 * NOTE: the exclusive/inclusive parameters are probably not right. They need
 *       either careful study or battle testing.
 *
 * That's pretty much it, happy Vim'ing!
 *
 *   -- Christian
 */

@binding-set builder-vim-source-view
{
  bind "Escape" { "set-overwrite" (0)
                  "clear-count" ()
                  "clear-selection" ()
                  "set-mode" ("vim-normal", permanent, 0) };
  bind "<ctrl>bracketleft" { "set-overwrite" (0)
                             "clear-count" ()
                             "clear-selection" ()
                             "set-mode" ("vim-normal", permanent, 0) };
}

@binding-set builder-vim-source-view-normal-with-count
{
  bind "0" { "append-to-count" (0)
             "set-mode" ("vim-normal-with-count", transient, 0) };
  bind "percent" { "movement" (line-percentage, 0, 1, 1)
                   "set-mode" ("vim-normal-with-count", transient, 0) };
}

@binding-set builder-vim-source-view-normal
{
  /* todo: need a submode that will allow 0 to be used. */
  bind "1" { "append-to-count" (1)
             "set-mode" ("vim-normal-with-count", transient, 0) };
  bind "2" { "append-to-count" (2)
             "set-mode" ("vim-normal-with-count", transient, 0) };
  bind "3" { "append-to-count" (3)
             "set-mode" ("vim-normal-with-count", transient, 0) };
  bind "4" { "append-to-count" (4)
             "set-mode" ("vim-normal-with-count", transient, 0) };
  bind "5" { "append-to-count" (5)
             "set-mode" ("vim-normal-with-count", transient, 0) };
  bind "6" { "append-to-count" (6)
             "set-mode" ("vim-normal-with-count", transient, 0) };
  bind "7" { "append-to-count" (7)
             "set-mode" ("vim-normal-with-count", transient, 0) };
  bind "8" { "append-to-count" (8)
             "set-mode" ("vim-normal-with-count", transient, 0) };
  bind "9" { "append-to-count" (9)
             "set-mode" ("vim-normal-with-count", transient, 0) };

  /* insert at cursor */
  bind "i" { "set-mode" ("vim-insert", permanent, 1) };

  /* insert after cursor */
  bind "a" { "set-mode" ("vim-insert", permanent, 1)
             "movement" (next-char, 0, 0, 0) };
  bind "<shift>a" { "set-mode" ("vim-insert", permanent, 1)
                    "movement" (last-char, 0, 0, 0) };

  /* insert at first non-whitespace character */
  bind "<shift>i" { "set-mode" ("vim-insert", permanent, 1)
                    "movement" (first-nonspace-char, 0, 1, 0) };

  /* insert line after current, insert mode */
  bind "o" { "set-mode" ("vim-insert", permanent, 1)
             "movement" (line-end, 0, 1, 0)
             "insert-at-cursor-and-indent" ("\n") };

  /* insert line before current */
  bind "<shift>o" { "set-mode" ("vim-insert", permanent, 1)
                    "movement" (first-char, 0, 0, 0)
                    "insert-at-cursor" ("\n")
                    "move-cursor" (display-lines, -1, 0)
                    "auto-indent" () };

  /* swallow the current character and go to insert */
  bind "s" { "set-mode" ("vim-insert", permanent, 1)
             "movement" (next-char, 1, 1, 1)
             "copy-clipboard" ()
             "delete-selection" () };

  bind "Left"  { "movement" (previous-char, 0, 1, 1)
                 "clear-count" () };
  bind "Right" { "movement" (next-char, 0, 1, 1)
                 "clear-count" () };
  bind "Up"    { "movement" (previous-line, 0, 1, 1)
                 "clear-count" () };
  bind "Down"  { "movement" (next-line, 0, 1, 1)
                 "clear-count" () };

  bind "h"     { "movement" (previous-char, 0, 1, 1)
                 "clear-count" () };
  bind "l"     { "movement" (next-char, 0, 1, 1)
                 "clear-count" () };
  bind "k"     { "movement" (previous-line, 0, 1, 1)
                 "clear-count" () };
  bind "j"     { "movement" (next-line, 0, 1, 1)
                 "clear-count" () };

  /* move to special sub-mode 'g' */
  bind "g" { "set-mode" ("vim-normal-g", transient ) };

  /* move by word ends */
  bind "e"        { "movement" (next-word-end, 0, 1, 1)
                    "clear-count" () };
  bind "<shift>e" { "movement" (next-full-word-end, 0, 1, 1)
                    "clear-count" () };

  /* move to by word start */
  bind "w"        { "movement" (next-word-start, 0, 1, 1)
                    "clear-count" () };
  bind "<shift>w" { "movement" (next-full-word-start, 0, 1, 1)
                    "clear-count" () };
  bind "b"        { "movement" (previous-word-start, 0, 1, 1)
                    "clear-count" () };
  bind "<shift>b" { "movement" (previous-full-word-start, 0, 1, 1)
                    "clear-count" () };

  /* page movements */
  bind "<ctrl>b" { "movement" (page-up, 0, 0, 1)
                   "clear-count" () };
  bind "<ctrl>f" { "movement" (page-down, 0, 0, 1)
                   "clear-count" () };
  bind "<ctrl>u" { "movement" (half-page-up, 0, 0, 1)
                   "clear-count" () };
  bind "<ctrl>d" { "movement" (half-page-down, 0, 0, 1)
                   "clear-count" () };

  /* screen movements, keeping cursor locked to visible region */
  bind "<ctrl>e" { "movement" (screen-up, 0, 0, 1)
                   "clear-count" () };
  bind "<ctrl>y" { "movement" (screen-down, 0, 0, 1)
                   "clear-count" () };
  bind "z" { "set-mode" ("vim-normal-z", transient, 0) };

  /* move by paragraph */
  bind "braceleft" { "movement" (paragraph-start, 0, 0, 1)
                     "clear-count" () };
  bind "braceright" { "movement" (paragraph-end, 0, 0, 1)
                      "clear-count" () };

  /* move by sentence */
  bind "parenleft" { "movement" (sentence-start, 0, 0, 1)
                     "clear-count" () };
  bind "parenright" { "movement" (sentence-end, 0, 0, 1)
                      "clear-count" () };

  /* move to line offset of zero, and first non-whitespace char, end of line */
  bind "0" { "movement" (first-char, 0, 1, 0)
             "clear-count" () };
  bind "<shift>asciicircum" { "movement" (first-nonspace-char, 0, 1, 0)
                              "clear-count" () };
  bind "dollar" { "movement" (last-char, 0, 1, 0)
                  "clear-count" () };
  bind "bar" { "movement" (nth-char, 0, 1, 1)
               "clear-count" () };

  /* jump to match of brace/bracket/comment/etc */
  bind "percent" { "move-to-matching-bracket" (0, 0, 1)
                   "clear-count" () };

  /* move based on visible screen area */
  bind "<shift>h" { "movement" (screen-top, 0, 0, 0)
                    "clear-count" () };
  bind "<shift>m" { "movement" (screen-middle, 0, 0, 0)
                    "clear-count" () };
  bind "<shift>l" { "movement" (screen-bottom, 0, 0, 0)
                    "clear-count" () };

  /* move to nth line, defaults to last */
  bind "<shift>g" { "movement" (nth-line, 0, 1, 1)
                    "movement" (first-nonspace-char, 0, 1, 0)
                    "clear-count" () };

  /* undo - todo: how do we land cursor on right spot? */
  bind "u" { "undo" ()
             "clear-count" ()
             "clear-selection" () };

  /* redo */
  bind "<ctrl>r" { "redo" ()
                   "clear-count" ()
		   "clear-selection" () };

  bind "p" { "paste-clipboard-extended" (1, 1, 1)
             "clear-count" () };
  bind "<shift>p" { "paste-clipboard-extended" (1, 0, 1)
                    "clear-count" () };

  /* overwrite */
  bind "<shift>r" { "set-mode" ("vim-insert", permanent, 1)
                    "set-overwrite" (1) };

 /* jump to sub-mode */
  bind "c" { "set-mode" ("vim-normal-c", transient, 0) };
  bind "d" { "set-mode" ("vim-normal-d", transient, 0) };

  /* delete to end of line */
  bind "<shift>d" { "movement" (last-char, 1, 0, 0)
                    "copy-clipboard" ()
                    "delete-selection" ()
                    "clear-count" () };

  /* delete current char */
  bind "x" { "movement" (next-char, 1, 1, 1)
             "copy-clipboard" ()
             "delete-selection" ()
             "clear-count" () };

  /* delete previous char */
  bind "<shift>x" { "movement" (previous-char, 1, 1, 1)
                    "copy-clipboard" ()
                    "delete-selection" ()
                    "clear-count" () };

  bind "greater" { "set-mode" ("vim-normal-indent", transient, 0) };
  bind "less" { "set-mode" ("vim-normal-indent", transient, 0) };

  /* join selected lines */
  bind "<shift>j" { "movement" (first-char, 0, 1, 0)
                    "movement" (next-line, 1, 1, 1)
                    "join-lines" ()
                    "movement" (last-char, 0, 0, 0)
                    "clear-count" () };

  /* change number */
  bind "<ctrl>a" { "change-number" (1)
                   "clear-count" () };
  bind "<ctrl>x" { "change-number" (-1)
                   "clear-count" () };

  /* toggle character case */
  bind "asciitilde" { "movement" (next-char, 1, 1, 1)
                      "change-case" (toggle)
                      "clear-count" () };

  /* todo: not quite right, should add movement that can span lines */
  bind "BackSpace" { "move-cursor" (logical-positions, -1, 0)
                     "clear-count" () };

  bind "KP_Enter" { "movement" (next-line, 0, 0, 1)
                    "clear-count" () };
  bind "<shift>KP_Enter" { "movement" (next-line, 0, 0, 1)
                           "clear-count" () };
  bind "Return" { "movement" (next-line, 0, 0, 1)
                  "clear-count" () };
  bind "<shift>Return" { "movement" (next-line, 0, 0, 0)
                         "clear-count" () };

  /* copy */
  bind "y" { "set-mode" ("vim-normal-y", transient, 0) };
  bind "<shift>y" { "save-insert-mark" ()
                    "movement" (first-char, 0, 0, 0)
                    "movement" (next-line, 1, 1, 1)
                    "copy-clipboard" ()
                    "selection-theatric" (expand)
                    "clear-count" ()
                    "clear-selection" ()
                    "restore-insert-mark" () };

  /* visual mode transition */
  bind "v" { "movement" (next-char, 1, 1, 1)
             "set-mode" ("vim-visual", permanent, 0) };
  bind "<shift>v" { "movement" (first-char, 0, 1, 0)
                    "movement" (next-line, 1, 0, 1)
                    "set-mode" ("vim-visual-line", permanent, 1) };
  bind "<ctrl>v" { "set-mode" ("vim-visual-block", permanent, 0) };
}

@binding-set builder-vim-source-view-normal-c
{
  bind "i" { "set-mode" ("vim-normal-c-i", transient, 0) };

  bind "e" { "set-mode" ("vim-insert", permanent, 1)
             "movement" (next-word-end, 1, 0, 1)
             "copy-clipboard" ()
             "delete-selection" () };
  bind "w" { "set-mode" ("vim-insert", permanent, 1)
             "movement" (next-word-end, 1, 0, 1)
             "copy-clipboard" ()
             "delete-selection" () };
}

@binding-set builder-vim-source-view-normal-c-i
{
  /* cip */
  bind "p" { "set-mode" ("vim-insert", permanent, 1)
             "movement" (paragraph-start, 1, 1, 1)
             "swap-selection-bounds" ()
             "movement" (paragraph-end, 1, 1, 1)
             "copy-clipboard" ()
             "selection-theatric" (shrink)
             "delete-selection" ()
             "clear-count" () };
}

@binding-set builder-vim-source-view-normal-d
{
  bind "Left"  { "movement" (previous-char, 1, 1, 1)
                 "copy-clipboard" ()
                 "delete-selection" () };
  bind "h"     { "movement" (previous-char, 1, 1, 1)
                 "copy-clipboard" ()
                 "delete-selection" () };

  bind "Right" { "movement" (next-char, 1, 1, 1)
                 "copy-clipboard" ()
                 "delete-selection" () };
  bind "l"     { "movement" (next-char, 1, 1, 1)
                 "copy-clipboard" ()
                 "delete-selection" () };

  bind "Up"    { "movement" (line-end, 0, 0, 0)
                 "movement" (previous-line, 1, 1, 0)
                 "movement" (previous-line, 1, 1, 1)
                 "copy-clipboard" ()
                 "delete-selection" () };
  bind "k"     { "movement" (line-end, 0, 0, 0)
                 "movement" (previous-line, 1, 1, 0)
                 "movement" (previous-line, 1, 1, 1)
                 "copy-clipboard" ()
                 "delete-selection" () };

  bind "Down"  { "movement" (first-char, 0, 1, 0)
                 "movement" (next-line, 1, 0, 0)
                 "movement" (next-line, 1, 0, 1)
                 "copy-clipboard" ()
                 "delete-selection" () };
  bind "j"     { "movement" (first-char, 0, 1, 0)
                 "movement" (next-line, 1, 0, 0)
                 "movement" (next-line, 1, 0, 1)
                 "copy-clipboard" ()
                 "delete-selection" () };

  bind "i" { "set-mode" ("vim-normal-d-i", transient, 0) };
  bind "g" { "set-mode" ("vim-normal-d-g", transient, 0) };

  bind "d" { "save-insert-mark" ()
             "movement" (first-char, 0, 1, 0)
             "movement" (next-line, 1, 0, 1)
             "copy-clipboard" ()
             "delete-selection" ()
             "restore-insert-mark" () };

  bind "e" { "movement" (next-word-end, 1, 0, 1)
             "copy-clipboard" ()
             "delete-selection" () };
  bind "<shift>e" { "movement" (next-full-word-end, 1, 0, 1)
                    "copy-clipboard" ()
                    "delete-selection" () };
  bind "w" { "movement" (next-word-start, 1, 1, 1)
             "copy-clipboard" ()
             "delete-selection" () };
  bind "<shift>w" { "movement" (next-full-word-start, 1, 1, 1)
                    "copy-clipboard" ()
                    "delete-selection" () };
  bind "0" { "movement" (first-char, 1, 0, 0)
             "copy-clipboard" ()
             "delete-selection" () };
  bind "<shift>asciicircum" { "movement" (first-nonspace-char, 1, 1, 1)
                              "copy-clipboard" ()
                              "delete-selection" () };
  bind "dollar" { "movement" (line-end, 1, 1, 0)
                  "copy-clipboard" ()
                  "delete-selection" () };
}

@binding-set builder-vim-source-view-normal-indent
{
  bind "greater" { "movement" (first-char, 0, 1, 0)
                   "movement" (line-end, 1, 1, 0)
                   "indent-selection" (1)
                   "clear-selection" ()
                   "movement" (first-nonspace-char, 0, 1, 0) };
  bind "less"    { "movement" (first-char, 0, 1, 0)
                   "movement" (line-end, 1, 1, 0)
                   "indent-selection" (-1)
                   "clear-selection" ()
                   "movement" (first-nonspace-char, 0, 1, 0) };
}

@binding-set builder-vim-source-view-normal-z
{
  bind "z" { "movement" (scroll-screen-center, 0, 0, 0) };
  bind "t" { "movement" (scroll-screen-top,    0, 0, 0) };
  bind "b" { "movement" (scroll-screen-bottom, 0, 0, 0) };
}

@binding-set builder-vim-source-view-visual-z
{
  bind "z" { "movement" (scroll-screen-center, 1, 0, 0)
             "set-mode" ("vim-visual", permanent, 0) };
  bind "t" { "movement" (scroll-screen-top, 1, 0, 0)
             "set-mode" ("vim-visual", permanent, 0) };
  bind "b" { "movement" (scroll-screen-bottom, 1, 0, 0)
             "set-mode" ("vim-visual", permanent, 0) };
}

@binding-set builder-vim-source-view-visual-line-z
{
  bind "z" { "movement" (scroll-screen-center, 1, 0, 0)
             "set-mode" ("vim-visual-line", permanent, 1) };
  bind "t" { "movement" (scroll-screen-top, 1, 0, 0)
             "set-mode" ("vim-visual-line", permanent, 1) };
  bind "b" { "movement" (scroll-screen-bottom, 1, 0, 0)
             "set-mode" ("vim-visual-line", permanent, 1) };
}

@binding-set builder-vim-source-view-normal-y
{
  bind "y" { "save-insert-mark" ()
             "movement" (first-char, 0, 1, 0)
             "movement" (next-line, 1, 1, 1)
             "copy-clipboard" ()
             "selection-theatric" (expand)
             "clear-selection" ()
             "restore-insert-mark" () };

  bind "j" { "save-insert-mark" ()
             "movement" (line-end, 0, 1, 0)
             "movement" (first-char, 0, 1, 0)
             "movement" (next-line, 1, 1, 0)
             "movement" (next-line, 1, 1, 1)
             "copy-clipboard" ()
             "selection-theatric" (expand)
             "clear-selection" ()
             "restore-insert-mark" () };

  bind "k" { "movement" (line-end, 0, 0, 0)
             "movement" (previous-line, 1, 1, 0)
             "movement" (previous-line, 1, 1, 1)
             "copy-clipboard" ()
             "selection-theatric" (expand)
             "clear-selection" ()
             "movement" (first-nonspace-char, 0, 1, 0) };
}

@binding-set builder-vim-source-view-normal-g
{
  bind "<shift>i" { "set-mode" ("vim-insert", permanent, 1)
                    "movement" (first-char, 0, 1, 0) };
  bind "e" { "movement" (previous-word-end, 0, 1, 1) };
  bind "<shift>e" { "movement" (previous-full-word-end, 0, 1, 1) };
  bind "g" { "movement" (first-line, 0, 1, 0 ) };
  bind "j" { "movement" (next-line, 0, 1, 1) };

  /* todo: this should actually be screen middle. this does middle of the text width */
  bind "m" { "movement" (middle-char, 0, 1, 0) };

  bind "u"        { "set-mode" ("vim-normal-g-u", transient, 0) };
  bind "<shift>u" { "set-mode" ("vim-normal-g-u", transient, 0) };
}

@binding-set builder-vim-source-view-normal-g-u
{
  bind "u" { "movement" (first-char, 0, 1, 0)
             "movement" (next-line, 1, 1, 1)
             "swap-selection-bounds" ()
             "selection-theatric" (expand)
             "change-case" (lower)
             "clear-selection" ()
             "movement" (first-nonspace-char, 0, 1, 0) };

  bind "<shift>u" { "movement" (first-char, 0, 1, 0)
                    "movement" (next-line, 1, 1, 1)
                    "swap-selection-bounds" ()
                    "selection-theatric" (expand)
                    "change-case" (upper)
                    "clear-selection" ()
                    "movement" (first-nonspace-char, 0, 1, 0) };
}

@binding-set builder-vim-source-view-normal-d-g
{
  bind "e" { "movement" (previous-word-end, 1, 1, 1)
             "delete-selection" () };
  bind "<shift>e" { "movement" (previous-full-word-end, 1, 1, 1)
                    "delete-selection" () };
  bind "g" { "movement" (first-line, 0, 0, 0)
             "delete-selection" () };
  bind "j" { "movement" (next-line, 0, 1, 1)
             "delete-selection" () };
  bind "m" { "movement" (middle-char, 0, 1, 0)
             "delete-selection" () };
}

@binding-set builder-vim-source-view-normal-d-i
{
  bind "p" { "movement" (paragraph-start, 1, 1, 1)
             "movement" (first-char, 1, 1, 0)
             "swap-selection-bounds" ()
             "movement" (paragraph-end, 1, 1, 1)
             "movement" (last-char, 1, 1, 0)
             "copy-clipboard" ()
             "selection-theatric" (shrink)
             "delete-selection" () };
}

@binding-set builder-vim-source-view-visual-g
{
  bind "e" { "movement" (previous-word-end, 1, 1, 0)
             "set-mode" ("vim-visual", permanent, 0) };
  bind "<shift>e" { "movement" (previous-full-word-end, 1, 1, 0)
                    "set-mode" ("vim-visual", permanent, 0) };
  bind "g" { "movement" (first-line, 1, 1, 0)
             "set-mode" ("vim-visual", permanent, 0) };
  bind "j" { "movement" (next-line, 1, 1, 0)
             "set-mode" ("vim-visual", permanent, 0) };
  bind "m" { "movement" (middle-char, 1, 1, 0)
             "set-mode" ("vim-visual", permanent, 0) };
}

@binding-set builder-vim-source-view-visual-line-g
{
  bind "g" { "movement" (first-line, 1, 1, 0)
             "set-mode" ("vim-visual-line", permanent, 1) };
  bind "j" { "movement" (next-line, 1, 1, 0)
             "set-mode" ("vim-visual-line", permanent, 1) };
}

@binding-set builder-vim-source-view-insert
{
  bind "<ctrl>u" { "movement" (line-chars, 1, 1, 0)
                   "delete-selection" () };
  bind "<ctrl>w" { "movement" (previous-word-start, 1)
                   "delete-selection" () };
  bind "<ctrl>n" { "cycle-completion" (down) };
  bind "<ctrl>p" { "cycle-completion" (up) };

  bind "<ctrl>e" { "movement" (screen-up, 0, 0, 1) };
  bind "<ctrl>y" { "movement" (screen-down, 0, 0, 1) };
}

@binding-set builder-vim-source-view-visual
{
  bind "percent" { "move-to-matching-bracket" (1) };

  bind "x" { "delete-selection" () };
  bind "<shift>x" { "delete-selection" () };

  bind "h" { "movement" (previous-char, 1, 1, 1) };
  bind "l" { "movement" (next-char, 1, 1, 1) };
  bind "k" { "movement" (previous-line, 1, 1, 1) };
  bind "j" { "movement" (next-line, 1, 1, 1) };

  bind "Left" { "movement" (previous-char, 1, 1, 1) };
  bind "Right" { "movement" (next-char, 1, 1, 1) };
  bind "Up" { "movement" (previous-line, 1, 1, 1) };
  bind "Down" { "movement" (next-line, 1, 1, 1) };

  bind "e" { "movement" (next-word-end, 1, 0, 1) };
  bind "<shift>e" { "movement" (next-full-word-end, 1, 0, 1) };

  bind "w" { "movement" (next-word-start, 1, 1, 1) };
  bind "<shift>w" { "movement" (next-full-word-start, 1, 1, 1) };
  bind "b" { "movement" (previous-word-start, 1, 1, 1) };
  bind "<shift>b" { "movement" (previous-full-word-start, 1, 1, 1) };

  bind "<ctrl>b" { "movement" (page-up, 1, 0, 1) };
  bind "<ctrl>f" { "movement" (page-down, 1, 0, 1) };
  bind "<ctrl>u" { "movement" (half-page-up, 1, 0, 1) };
  bind "<ctrl>d" { "movement" (half-page-down, 1, 0, 1) };

  bind "greater" { "indent-selection" (1)
                   "movement" (first-nonspace-char, 0, 1, 0)
                   "set-mode" ("vim-normal", permanent, 0) };
  bind "less" { "indent-selection" (-1)
                "movement" (first-nonspace-char, 0, 1, 0)
                "set-mode" ("vim-normal", permanent, 0) };

  bind "0" { "movement" (first-char, 1, 1, 0) };
  bind "<shift>asciicircum" { "movement" (first-nonspace-char, 1, 0, 0) };
  bind "dollar" { "movement" (last-char, 1, 1, 0) };
  bind "bar" { "movement" (nth-char, 1, 1, 1) };

  bind "<shift>h" { "movement" (screen-top, 1, 0, 0) };
  bind "<shift>m" { "movement" (screen-middle, 1, 0, 0) };
  bind "<shift>l" { "movement" (screen-bottom, 1, 0, 0) };

  bind "braceleft" { "movement" (paragraph-start, 1, 1, 1) };
  bind "braceright" { "movement" (paragraph-end, 1, 1, 1) };

  bind "parenleft" { "movement" (sentence-start, 1, 1, 1) };
  bind "parenright" { "movement" (sentence-end, 1, 1, 1) };

  bind "<ctrl>e" { "movement" (screen-up, 1, 0, 1) };
  bind "<ctrl>y" { "movement" (screen-down, 1, 0, 1) };

  bind "<shift>j" { "join-lines" ()
                    "selection-theatric" (expand)
                    "clear-selection" ()
                    "movement" (last-char, 0, 1, 0)
                    "set-mode" ("vim-normal", permanent, 0) };

  bind "g" { "set-mode" ("vim-visual-g", transient, 0) };
  bind "z" { "set-mode" ("vim-visual-z", transient, 0) };
}

@binding-set builder-vim-source-view-visual-line
{
  bind "k" { "movement" (previous-line, 1, 0, 1) };
  bind "j" { "movement" (next-line, 1, 0, 1) };

  /* just to be nice */
  bind "h" { "clear-selection" ()
             "set-mode" ("vim-normal", permanent, 0) };
  bind "l" { "clear-selection" ()
             "set-mode" ("vim-normal", permanent, 0) };

  bind "Up" { "movement" (previous-line, 1, 0, 1) };
  bind "Down" { "movement" (next-line, 1, 0, 1) };

  bind "z" { "set-mode" ("vim-visual-line-z", transient, 0) };

  bind "x"        { "copy-clipboard" ()
                    "delete-selection" ()
                    "delete-from-cursor" (chars, 1)
                    "set-mode" ("vim-normal", permanent, 0) };

  bind "<shift>x" { "copy-clipboard" ()
                    "delete-selection" ()
                    "delete-from-cursor" (chars, 1)
                    "set-mode" ("vim-normal", permanent, 0) };

  bind "y"        { "copy-clipboard" ()
                    "selection-theatric" (expand)
                    "clear-selection" ()
                    "set-mode" ("vim-normal", permanent, 0) };

  bind "<shift>y" { "copy-clipboard" ()
                    "selection-theatric" (expand)
                    "clear-selection" ()
                    "set-mode" ("vim-normal", permanent, 0) };

  bind "<shift>j" { "join-lines" ()
                    "selection-theatric" (expand)
                    "clear-selection" ()
                    "movement" (last-char, 0, 1, 0)
                    "set-mode" ("vim-normal", permanent, 0) };

  bind "asciitilde" { "selection-theatric" (expand)
                      "change-case" (toggle)
                      "clear-selection" ()
                      "set-mode" ("vim-normal", permanent, 0) };

  bind "<shift>u" { "selection-theatric" (expand)
                    "change-case" (upper)
                    "clear-selection" ()
                    "set-mode" ("vim-normal", permanent, 0) };
  bind "u" { "selection-theatric" (expand)
             "change-case" (lower)
             "clear-selection" ()
             "set-mode" ("vim-normal", permanent, 0) };

  bind "braceleft" { "movement" (paragraph-start, 1, 1, 1)
                     "movement" (last-char, 1, 1, 0) };
  bind "braceright" { "movement" (paragraph-end, 1, 1, 1)
                      "movement" (last-char, 1, 1, 0) };

  bind "parenleft" { "movement" (sentence-start, 1, 1, 1)
                     "movement" (last-char, 1, 1, 0) };
  bind "parenright" { "movement" (sentence-end, 1, 1, 1)
                      "movement" (last-char, 1, 1, 0) };

  bind "greater" { "indent-selection" (1)
                   "clear-selection" ()
                   "movement" (first-nonspace-char, 0, 1, 0)
                   "set-mode" ("vim-normal", permanent, 0) };
  bind "less" { "indent-selection" (-1)
                "clear-selection" ()
                "movement" (first-nonspace-char, 0, 1, 0)
                "set-mode" ("vim-normal", permanent, 0) };

  bind "<ctrl>e" { "movement" (screen-up, 1, 0, 1) };
  bind "<ctrl>y" { "movement" (screen-down, 1, 0, 1) };

  /* page movements */
  bind "<ctrl>b" { "movement" (page-up, 1, 0, 1)
                   "clear-count" () };
  bind "<ctrl>f" { "movement" (page-down, 1, 0, 1)
                   "clear-count" () };
  bind "<ctrl>u" { "movement" (half-page-up, 1, 0, 1)
                   "clear-count" () };
  bind "<ctrl>d" { "movement" (half-page-down, 1, 0, 1)
                   "clear-count" () };
}

@binding-set builder-vim-source-view-visual-block
{
}

@binding-set builder-vim-tree-view
{
  bind "<ctrl>n" { "move-cursor" (logical-positions, 1) };
  bind "<ctrl>p" { "move-cursor" (logical-positions, -1) };
}

/*
 * Sadly, this will draw from the middle, so it does not result in our
 * cursor being over the actual character, but between two characters.
 *
 *   IdeSourceView {
 *     -GtkWidget-cursor-aspect-ratio: 0.5;
 *   }
 */

IdeSourceViewMode.default,
IdeSourceViewMode.vim-normal {
  gtk-key-bindings: builder-vim-source-view,
                    builder-vim-source-view-normal;
}

IdeSourceViewMode.vim-normal-with-count {
  gtk-key-bindings: builder-vim-source-view,
                    builder-vim-source-view-normal-with-count,
                    builder-vim-source-view-normal;
}

IdeSourceViewMode.vim-normal-c {
  gtk-key-bindings: builder-vim-source-view,
                    builder-vim-source-view-normal-c;
}

IdeSourceViewMode.vim-normal-c-i {
  gtk-key-bindings: builder-vim-source-view,
                    builder-vim-source-view-normal-c-i;
}

IdeSourceViewMode.vim-normal-d {
  gtk-key-bindings: builder-vim-source-view,
                    builder-vim-source-view-normal-d;
}

IdeSourceViewMode.vim-normal-d-g {
  gtk-key-bindings: builder-vim-source-view,
                    builder-vim-source-view-normal-d-g;
}

IdeSourceViewMode.vim-normal-d-i {
  gtk-key-bindings: builder-vim-source-view,
                    builder-vim-source-view-normal-d-i;
}

IdeSourceViewMode.vim-normal-g {
  gtk-key-bindings: builder-vim-source-view,
                    builder-vim-source-view-normal-g;
}

IdeSourceViewMode.vim-normal-g-u {
  gtk-key-bindings: builder-vim-source-view,
                    builder-vim-source-view-normal-g-u;
}

IdeSourceViewMode.vim-normal-indent {
  gtk-key-bindings: builder-vim-source-view,
                    builder-vim-source-view-normal-indent;
}

IdeSourceViewMode.vim-normal-y {
  gtk-key-bindings: builder-vim-source-view,
                    builder-vim-source-view-normal-y;
}

IdeSourceViewMode.vim-normal-z {
  gtk-key-bindings: builder-vim-source-view,
                    builder-vim-source-view-normal-z;
}

IdeSourceViewMode.vim-insert {
  gtk-key-bindings: builder-vim-source-view,
                    builder-vim-source-view-insert;
}

IdeSourceViewMode.vim-visual {
  gtk-key-bindings: builder-vim-source-view,
                    builder-vim-source-view-visual;
}

IdeSourceViewMode.vim-visual-g {
  gtk-key-bindings: builder-vim-source-view,
                    builder-vim-source-view-visual-g;
}

IdeSourceViewMode.vim-visual-z {
  gtk-key-bindings: builder-vim-source-view,
                    builder-vim-source-view-visual-z;
}

IdeSourceViewMode.vim-visual-line {
  gtk-key-bindings: builder-vim-source-view,
                    builder-vim-source-view-visual-line;
}

IdeSourceViewMode.vim-visual-line-g {
  gtk-key-bindings: builder-vim-source-view,
                    builder-vim-source-view-visual-line-g;
}

IdeSourceViewMode.vim-visual-line-z {
  gtk-key-bindings: builder-vim-source-view,
                    builder-vim-source-view-visual-line-z;
}

IdeSourceViewMode.vim-visual-block {
  gtk-key-bindings: builder-vim-source-view, builder-vim-source-view-visual-block;
}

GtkTreeView {
  gtk-key-bindings: builder-vim-tree-view;
}
